import mysql.connector
from mysql.connector import Error
from datetime import datetime

# Database connection details (update with your MySQL credentials)
DB_HOST = 'localhost'
DB_USER = 'root'  # Default for XAMPP
DB_PASSWORD = ''  # Leave blank if no password
DB_NAME = 'bank_db'

class BankManagement:
    def __init__(self):
        self.connection = None
        self.logged_in_account = None  # Tracks logged-in account
        self.connect_db()

    def connect_db(self):
        try:
            self.connection = mysql.connector.connect(
                host=DB_HOST,
                user=DB_USER,
                password=DB_PASSWORD,
                database=DB_NAME
            )
            if self.connection.is_connected():
                print("Connected to MySQL database.")
                self.create_tables()  # Create tables if they don't exist
        except Error as e:
            print(f"Error connecting to database: {e}")

    def create_tables(self):
        cursor = self.connection.cursor()
        # Accounts table with password
        create_accounts_query = """
        CREATE TABLE IF NOT EXISTS accounts (
            account_no INT PRIMARY KEY AUTO_INCREMENT,
            name VARCHAR(100) NOT NULL,
            password VARCHAR(100) NOT NULL,
            balance FLOAT DEFAULT 0.0
        );
        """
        # Transactions table for history
        create_transactions_query = """
        CREATE TABLE IF NOT EXISTS transactions (
            id INT PRIMARY KEY AUTO_INCREMENT,
            account_no INT,
            type VARCHAR(50),  -- e.g., 'Deposit', 'Withdraw', 'Transfer'
            amount FLOAT,
            date_time DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (account_no) REFERENCES accounts(account_no)
        );
        """
        cursor.execute(create_accounts_query)
        cursor.execute(create_transactions_query)
        self.connection.commit()
        cursor.close()

    def create_account(self, name, password, initial_balance=0.0):
        if initial_balance < 0:
            print("Initial balance cannot be negative.")
            return
        cursor = self.connection.cursor()
        insert_query = "INSERT INTO accounts (name, password, balance) VALUES (%s, %s, %s)"
        cursor.execute(insert_query, (name, password, initial_balance))
        self.connection.commit()
        account_no = cursor.lastrowid
        # Log initial deposit if balance > 0
        if initial_balance > 0:
            self.log_transaction(account_no, 'Deposit', initial_balance)
        cursor.close()
        print(f"Account created successfully! Account No: {account_no}")
        return account_no

    def login(self, account_no, password):
        cursor = self.connection.cursor()
        cursor.execute("SELECT name FROM accounts WHERE account_no = %s AND password = %s", (account_no, password))
        result = cursor.fetchone()
        cursor.close()
        if result:
            self.logged_in_account = account_no
            print(f"Logged in as {result[0]} (Account {account_no}).")
            return True
        else:
            print("Invalid account number or password.")
            return False

    def logout(self):
        self.logged_in_account = None
        print("Logged out.")

    def log_transaction(self, account_no, trans_type, amount):
        cursor = self.connection.cursor()
        insert_query = "INSERT INTO transactions (account_no, type, amount) VALUES (%s, %s, %s)"
        cursor.execute(insert_query, (account_no, trans_type, amount))
        self.connection.commit()
        cursor.close()

    def deposit(self, amount):
        if not self.logged_in_account:
            print("Please log in first.")
            return
        if amount <= 0:
            print("Deposit amount must be positive.")
            return
        cursor = self.connection.cursor()
        cursor.execute("SELECT balance FROM accounts WHERE account_no = %s", (self.logged_in_account,))
        result = cursor.fetchone()
        if result:
            new_balance = result[0] + amount
            cursor.execute("UPDATE accounts SET balance = %s WHERE account_no = %s", (new_balance, self.logged_in_account))
            self.connection.commit()
            self.log_transaction(self.logged_in_account, 'Deposit', amount)
            print(f"Deposited {amount}. New balance: {new_balance}")
        cursor.close()

    def withdraw(self, amount):
        if not self.logged_in_account:
            print("Please log in first.")
            return
        if amount <= 0:
            print("Withdrawal amount must be positive.")
            return
        cursor = self.connection.cursor()
        cursor.execute("SELECT balance FROM accounts WHERE account_no = %s", (self.logged_in_account,))
        result = cursor.fetchone()
        if result and result[0] >= amount:
            new_balance = result[0] - amount
            cursor.execute("UPDATE accounts SET balance = %s WHERE account_no = %s", (new_balance, self.logged_in_account))
            self.connection.commit()
            self.log_transaction(self.logged_in_account, 'Withdraw', amount)
            print(f"Withdrew {amount}. New balance: {new_balance}")
        else:
            print("Insufficient balance or account not found.")
        cursor.close()

    def check_balance(self):
        if not self.logged_in_account:
            print("Please log in first.")
            return
        cursor = self.connection.cursor()
        cursor.execute("SELECT balance FROM accounts WHERE account_no = %s", (self.logged_in_account,))
        result = cursor.fetchone()
        cursor.close()
        if result:
            print(f"Your balance: {result[0]}")

    def transfer(self, to_account, amount):
        if not self.logged_in_account:
            print("Please log in first.")
            return
        if amount <= 0:
            print("Transfer amount must be positive.")
            return
        if self.logged_in_account == to_account:
            print("Cannot transfer to the same account.")
            return
        cursor = self.connection.cursor()
        # Check sender's balance
        cursor.execute("SELECT balance FROM accounts WHERE account_no = %s", (self.logged_in_account,))
        from_result = cursor.fetchone()
        # Check receiver's account
        cursor.execute("SELECT balance FROM accounts WHERE account_no = %s", (to_account,))
        to_result = cursor.fetchone()
        if from_result and to_result and from_result[0] >= amount:
            new_from_balance = from_result[0] - amount
            new_to_balance = to_result[0] + amount
            cursor.execute("UPDATE accounts SET balance = %s WHERE account_no = %s", (new_from_balance, self.logged_in_account))
            cursor.execute("UPDATE accounts SET balance = %s WHERE account_no = %s", (new_to_balance, to_account))
            self.connection.commit()
            self.log_transaction(self.logged_in_account, 'Transfer Out', amount)
            self.log_transaction(to_account, 'Transfer In', amount)
            print(f"Transferred {amount} to account {to_account}.")
        else:
            print("Insufficient balance or invalid receiver account.")
        cursor.close()

    def view_transaction_history(self):
        if not self.logged_in_account:
            print("Please log in first.")
            return
        cursor = self.connection.cursor()
        cursor.execute("SELECT type, amount, date_time FROM transactions WHERE account_no = %s ORDER BY date_time DESC", (self.logged_in_account,))
        results = cursor.fetchall()
        cursor.close()
        if results:
            print("Transaction History:")
            for row in results:
                print(f"{row[2]} - {row[0]}: {row[1]}")
        else:
            print("No transactions found.")

    def apply_interest(self, rate=0.05):  # 5% monthly interest
        if not self.logged_in_account:
            print("Please log in first.")
            return
        cursor = self.connection.cursor()
        cursor.execute("SELECT balance FROM accounts WHERE account_no = %s", (self.logged_in_account,))
        result = cursor.fetchone()
        if result:
            interest = result[0] * rate
            new_balance = result[0] + interest
            cursor.execute("UPDATE accounts SET balance = %s WHERE account_no = %s", (new_balance, self.logged_in_account))
            self.connection.commit()
            self.log_transaction(self.logged_in_account, 'Interest', interest)
            print(f"Applied {rate*100}% interest: {interest}. New balance: {new_balance}")
        cursor.close()

    def close_account(self):
        if not self.logged_in_account:
            print("Please log in first.")
            return
        cursor = self.connection.cursor()
        cursor.execute("SELECT balance FROM accounts WHERE account_no = %s", (self.logged_in_account,))
        result = cursor.fetchone()
        if result and result[0] == 0:
            cursor.execute("DELETE FROM transactions WHERE account_no = %s", (self.logged_in_account,))
            cursor.execute("DELETE FROM accounts WHERE account_no = %s", (self.logged_in_account,))
            self.connection.commit()
            print("Account closed successfully.")
            self.logout()
        else:
            print("Cannot close account: Balance must be zero.")
        cursor.close()

    def close_connection(self):
        if self.connection.is_connected():
            self.connection.close()
            print("Database connection closed.")

# Menu-driven interface
def main():
    bank = BankManagement()
    while True:
        if not bank.logged_in_account:
            print("\n--- Bank Management System ---")
            print("1. Create Account")
            print("2. Login")
            print("3. Exit")
            choice = input("Enter choice: ")
            if choice == '1':
                name = input("Enter name: ")
                password = input("Enter password: ")
                balance = float(input("Enter initial balance: "))
                bank.create_account(name, password, balance)
            elif choice == '2':
                acc = int(input("Enter account no: "))
                pwd = input("Enter password: ")
                bank.login(acc, pwd)
            elif choice == '3':
                bank.close_connection()
                break
            else:
                print("Invalid choice.")
        else:
            print("\n--- Logged In Menu ---")
            print("1. Deposit")
            print("2. Withdraw")
            print("3. Check Balance")
            print("4. Transfer Money")
            print("5. View Transaction History")
            print("6. Apply Interest")
            print("7. Close Account")
            print("8. Logout")
            choice = input("Enter choice: ")
            if choice == '1':
                amt = float(input("Enter deposit amount: "))
                bank.deposit(amt)
            elif choice == '2':
                amt = float(input("Enter withdrawal amount: "))
                bank.withdraw(amt)
            elif choice == '3':
                bank.check_balance()
            elif choice == '4':
                to_acc = int(input("Enter receiver account no: "))
                amt = float(input("Enter transfer amount: "))
                bank.transfer(to_acc, amt)
            elif choice == '5':
                bank.view_transaction_history()
            elif choice == '6':
                bank.apply_interest()
            elif choice == '7':
                bank.close_account()
            elif choice == '8':
                bank.logout()
            else:
                print("Invalid choice.")

if __name__ == "__main__":
    main()
